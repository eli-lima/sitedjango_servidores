{% extends 'base.html' %}

{% block content %}
  <div class="pt-48 flex justify-center">
    <div class="flex flex-col items-center">
      <h1 class="text-2xl font-bold mb-4">Status do Processamento</h1>

      <!-- Status do processamento -->
      <div id="status" class="text-center text-lg font-semibold">
          {{ status }}
      </div>

      <!-- SeÃ§Ã£o de loading com spinner e barra de progresso -->
      <div id="loading-section" class="mt-4 flex flex-col items-center {% if status not in 'Pendente, Em andamento' %}hidden{% endif %}">
        <!-- Spinner -->
        <div class="loader mb-4"></div>

        <!-- Barra de progresso -->
        <div class="w-64 bg-gray-200 rounded-full overflow-hidden">
          <div id="progress-bar" class="h-4 bg-blue-500 animate-progress"></div>
        </div>
      </div>

      <!-- SeÃ§Ã£o de Resultados (Aparece apenas se a task foi concluÃ­da) -->
      <div id="result-section" class="mt-6 text-center {% if status != 'ConcluÃ­do com sucesso!' %}hidden{% endif %}">
        <p class="text-green-600 font-semibold">âœ… Novos Internos Inseridos: <span id="novos-inseridos">{{ novos_inseridos }}</span></p>
        <p class="text-blue-600 font-semibold">ðŸ”„ Internos Atualizados: <span id="atualizados">{{ atualizados }}</span></p>
      </div>
    </div>
  </div>

  <script>
    function atualizarStatus() {
        fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, 'text/html');

            let novoStatus = doc.getElementById('status').innerText.trim();
            let novosInseridos = doc.getElementById('novos-inseridos') ? doc.getElementById('novos-inseridos').innerText.trim() : "0";
            let atualizados = doc.getElementById('atualizados') ? doc.getElementById('atualizados').innerText.trim() : "0";

            document.getElementById('status').innerText = novoStatus;

            if (novoStatus.includes("pendente") || novoStatus.includes("Em andamento")) {
                document.getElementById('loading-section').classList.remove('hidden');
                document.getElementById('progress-bar').classList.remove('hidden');
            } else {
                document.getElementById('loading-section').classList.add('hidden');
                document.getElementById('progress-bar').classList.add('hidden');

                // Exibe a seÃ§Ã£o de resultados se for concluÃ­do com sucesso
                if (novoStatus.includes("ConcluÃ­do com sucesso")) {
                    document.getElementById('result-section').classList.remove('hidden');
                    document.getElementById('novos-inseridos').innerText = novosInseridos;
                    document.getElementById('atualizados').innerText = atualizados;
                }

                clearInterval(statusInterval);
            }
        });
    }

    // Atualiza o status a cada 5 segundos
    var statusInterval = setInterval(atualizarStatus, 5000);
  </script>

  <style>
    @keyframes progress {
      0% { width: 0%; }
      100% { width: 100%; }
    }
    .animate-progress {
      animation: progress 2s linear infinite;
    }
    /* Spinner */
    .loader {
      width: 80px;
      height: 80px;
      border: 4px solid rgba(0, 0, 255, 0.3);
      border-top-color: blue;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
{% endblock %}
