{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block titulo %}
Adicionar Ajuda de Custo
{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8 py-6">
    <div class="bg-white rounded-xl shadow-md p-6 sm:p-8 max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Preencha o MÃªs e Ano</h1>
        </div>

        <!-- Main Form -->
        <form method="POST" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <!-- Month/Year Selection -->
            <div class="flex flex-col sm:flex-row gap-6 justify-center">
                <!-- Month Field -->
                <div class="flex-1">
                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">
                        {{ form.mes.label }}
                    </label>
                    {{ form.mes }}
                    {% if form.mes.errors %}
                        <ul class="mt-1 text-sm text-red-600">
                            {% for error in form.mes.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>

                <!-- Year Field -->
                <div class="flex-1">
                    <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">
                        {{ form.ano.label }}
                    </label>
                    {{ form.ano }}
                    {% if form.ano.errors %}
                        <ul class="mt-1 text-sm text-red-600">
                            {% for error in form.ano.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>

            <!-- Dates Form Section -->
            <div class="border border-gray-200 rounded-lg p-4 sm:p-6 mt-8">
                <h2 class="text-center text-xl sm:text-2xl font-bold text-gray-800 mb-6">Adicionar Datas</h2>

                <div id="formContainer" class="space-y-4">
                    <!-- Initial Form Row -->
                    <div class="flex flex-col sm:flex-row gap-4 items-start border-b border-gray-100 pb-4 form-row" id="formRow_1">
                        <!-- Day Field -->
                        <div class="flex-1">
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">
                                {{ form.dia.label }}
                            </label>
                            {{ form.dia }}
                            {% if form.dia.errors %}
                                <ul class="mt-1 text-sm text-red-600">
                                    {% for error in form.dia.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>

                        <!-- Unit Field -->
                        <div class="flex-1">
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">
                                {{ form.unidade.label }}
                            </label>
                            {{ form.unidade }}
                            {% if form.unidade.errors %}
                                <ul class="mt-1 text-sm text-red-600">
                                    {% for error in form.unidade.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>

                        <!-- Work Hours Field -->
                        <div class="flex-1">
                            <label class="block text-sm sm:text-base font-medium text-gray-700 mb-1">
                                {{ form.carga_horaria.label }}
                            </label>
                            {{ form.carga_horaria }}
                            {% if form.carga_horaria.errors %}
                                <ul class="mt-1 text-sm text-red-600">
                                    {% for error in form.carga_horaria.errors %}
                                        <li>{{ error }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-2 sm:w-auto">
                            <button type="button" class="add-date-btn px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm sm:text-base">
                                <i class="bi bi-plus-circle"></i>
                            </button>
                            <button type="button" class="remove-date-btn px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm sm:text-base" disabled>
                                <i class="bi bi-trash-fill"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex justify-center mt-8">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 text-sm sm:text-base">
                    Enviar Datas
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    let formCounter = 1;
    const maxForms = 16;

    // Event delegation for add/remove buttons
    document.getElementById('formContainer').addEventListener('click', function (e) {
        // Add new form row
        if (e.target && e.target.closest('.add-date-btn')) {
            if (formCounter >= maxForms) {
                return;
            }
            formCounter++;

            const firstRow = document.querySelector('.form-row');
            const newFormRow = firstRow.cloneNode(true);

            // Update cloned fields with new IDs and names
            newFormRow.id = `formRow_${formCounter}`;
            newFormRow.classList.remove('border-b');
            newFormRow.querySelectorAll('input, select').forEach(function (input) {
                const name = input.name.split('_')[0];
                input.name = `${name}_${formCounter}`;
                input.id = `${name}_${formCounter}`;
                input.value = '';
                input.classList.remove('is-invalid');
            });

            // Clear any error messages
            const errorLists = newFormRow.querySelectorAll('ul');
            errorLists.forEach(list => list.remove());

            document.getElementById('formContainer').appendChild(newFormRow);

            // Disable add button if max forms reached
            if (formCounter >= maxForms) {
                document.querySelector('.add-date-btn').setAttribute('disabled', 'disabled');
            }

            // Enable remove buttons for all rows
            document.querySelectorAll('.remove-date-btn').forEach(btn => btn.removeAttribute('disabled'));
        }

        // Remove form row
        if (e.target && e.target.closest('.remove-date-btn')) {
            const rowToRemove = e.target.closest('.form-row');
            if (document.querySelectorAll('.form-row').length > 1) {
                rowToRemove.remove();
                formCounter--;

                // Re-enable add button if below max
                if (formCounter < maxForms) {
                    document.querySelector('.add-date-btn').removeAttribute('disabled');
                }

                // Disable remove button if only one row left
                if (formCounter === 1) {
                    document.querySelector('.remove-date-btn').setAttribute('disabled', 'disabled');
                }
            }
        }
    });
});
</script>
{% endblock %}